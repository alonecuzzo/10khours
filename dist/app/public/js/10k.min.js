$(function(){function h(e,t){var n=0,r=0;if(e<t)r=t-e;else if(t<e)r=e-t;else if(t===e)return;p(n,r,e,t)}function p(e,r,i,s){console.debug(">>>> Do swapping");var o=$("ul").children(),u=i<s,a=i+e,f=i+e+1;u||(a=i-e-1,f=i-e);var l=o.eq(a),c=o.eq(f);d(l,c,u,t,n,function(){e++;if(e>=r)return;p(e,r,i,s)})}function d(e,t,n,r,i,s){var o=e.outerHeight();n?e.css("z-index","999"):t.css("z-index","999"),e.animate({top:o},{duration:r,queue:!1,easing:i,complete:function(){n?e.insertAfter(t):t.insertBefore(e),v(e),v(t),s()}}),t.animate({top:-o},{duration:r,queue:!1,easing:i})}function v(e){e.css({position:"static",top:"0"}),e.css("z-index","0")}var e=150,t=100,n="easeInQuart";window.Task=Backbone.Model.extend({defaults:function(){return{title:"default value",displayTime:"0:00:00",order:i.nextOrder(),sessions:[],totalTime:0}},initialize:function(){this.set({isRecording:!1}),this.set("displayTime","0:00:00"),this.set("totalTime",this.getTotalTime(Date.today().last().sunday().getTime()))},updateDisplayTime:function(e){this.set("displayTime",e),this.set("totalTime",this.getTotalTime(Date.today().last().sunday().getTime())),this.save()},startSession:function(){this.set({isRecording:!0}),this.set({justStopped:!1}),this.set("displayTime","0:00:00");var e=this.get("sessions"),t=this,n={totalTime:0,startDate:(new Date).getTime(),endDate:Number.MAX_VALUE,timerInterval:null,startSession:function(){var e=0,n=this;this.timerInterval=setInterval(function(){e+=1,n.totalTime=e;var r=(new Date).clearTime().addSeconds(e).toString("H:mm:ss");t.updateDisplayTime(r)},1e3)},stopSession:function(){clearInterval(this.timerInterval)}};this.set("currentSession",n),n.startSession(),e.push(n)},stopSession:function(){var e=this.get("currentSession"),t=Date.today().getTime();this.set({justStopped:!0}),e.endDate=(new Date).getTime(),e.stopSession(),this.set("totalTime",this.getTotalTime(t)),this.set({isRecording:!1}),this.set("displayTime","0:00:00"),this.set("currentSession",null),this.save()},getTotalTime:function(e){var t,n=0,r=0,i=this.get("sessions"),s=i.length;e>0&&(n=e);for(t=0;t<=s-1;t++)i[t].endDate>n&&(r+=parseInt(i[t].totalTime,10));return r},getDailyPercentage:function(){var e=10800,t=this.getTotalTime(Date.today().getTime()),n=Math.round(t/e*100)/100;return n<.05&&(n=.05),n>1&&(n=1),n*100},getWeeklyPercentage:function(){var e=68400,t=this.getTotalTime(Date.today().last().sunday().getTime());return Math.round(t/e*100)/100},matchOrderIndex:function(e){this.set("order",e),this.save()}});var r=Backbone.Collection.extend({model:window.Task,currentPlaceholderIndex:Number.MAX_VALUE,localStorage:new Backbone.LocalStorage("tasks-backbone"),nextOrder:function(){return this.length?this.last().get("order")+1:0},comparator:function(e){return e.get("order")},logStartSession:function(e){this.activeSession=e},logStopSession:function(){this.activeSession=null},stopActiveSession:function(){this.activeSession&&this.activeSession.stopSession()},updateListOrder:function(e,t){var n;_.each(this.models,function(t){t.get("order")===e&&(n=t)});if(n){this.models.splice(_.indexOf(this.models,n),1),this.models.splice(this.models.length-t,0,n);var r;for(r=0;r<=this.models.length-1;r++)this.models[r].set("order",r),this.models[r].save()}}}),i=new r,s=Backbone.View.extend({tagName:"li",template:_.template("<div class='view' id='item'><div id='item-template'><div id='task-title'><%- title %></div><div id='task-display-time'><%- displayTime %></div><div id='task-total-time'>Total time: <%- totalTime %></div><div class='ui-progress-bar blue ui-container'><div class='ui-progress'></div></div><a class='destroy'></a></div></div></div>"),events:{mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseClick",mouseenter:"onMouseOver",mouseleave:"onMouseOut"},initialize:function(){var e=$(this.$el);this.model.on("change",this.render,this),this.hasBeenDragged=!1,this.mousedown=!1},render:function(){var e=this.$el;e.html(this.template(this.model.toJSON()));var t=$(e).find(".ui-progress"),n=$(e).find("#task-display-time"),r=this.model.getDailyPercentage();return t.width(r+"%"),this.model.get("justStopped")===!0&&(this.model.set({justStopped:!1}),this.delegateEvents(this.events),this.onMouseOut()),this.model.get("isRecording")===!0?n.show():n.hide(),this},onMouseDoubleClick:function(){window.location="http://localhost:4567/#task/"+this.model.get("order")},onMouseOut:function(){var e=$(this.$el),t=e.find("#task-display-time");e.animate({backgroundColor:"#FFFFFF"},100),e.animate({borderColor:"#CCCCCC"},100),e.css({color:"#666666"},100)},onMouseOver:function(){var e=$(this.$el);e.css({borderColor:"#9a63f5",backgroundColor:"#418fdc",color:"#F7F7F7"})},onMouseClick:function(){var e=this;this.mousedown=!1,this.alreadyClicked?(this.alreadyClicked=!1,clearTimeout(this.alreadyClickedTimeout),this.onMouseDoubleClick()):(this.alreadyClicked=!0,this.alreadyClickedTimeout=setTimeout(function(){e.alreadyClicked=!1,e.startSession()},300))},onMouseMove:function(){this.mousedown===!0&&(this.hasBeenDragged=!0)},onMouseDown:function(){this.mousedown=!0},clearDoubleClickInterval:function(){clearInterval(this.alreadyClickedTimeout)},animateSelectedTask:function(t,n){var r="#FFFFFF",i="#CCCCCC",s="#666",o="inline";n===!0&&(r="#9a63f5",i="#773fd3",s="#FFFFFF"),t.animate({backgroundColor:r},e),t.animate({color:s},10),t.css({borderColor:i})},setDraggingFalse:function(){this.isDragging=!1,this.undelegateEvents(),this.delegateEvents(this.events),this.hasBeenDragged=!0},startSession:function(){var e=i.currentPlaceholderIndex,t=this.model.get("order");if(this.model.get("isRecording")!==!0&&this.hasBeenDragged!==!0){this.undelegateEvents(),this.delegateEvents({mouseup:"stopSession"}),i.stopActiveSession(),i.logStartSession(this.model),this.model.startSession();var n=$(this.$el);this.animateSelectedTask(n,!0)}else this.hasBeenDragged===!0&&i.updateListOrder(t,e);i.currentPlaceholderIndex=Number.MAX_VALUE,this.hasBeenDragged=!1,this.mousedown=!1},stopSession:function(){if(this.model.get("isRecording")===!0){this.undelegateEvents(),this.delegateEvents(this.events),i.logStopSession(),this.model.stopSession();var e=$(this.$el);this.animateSelectedTask(e,!1)}},close:function(){},clear:function(){this.model.destroy()}}),o=Backbone.View.extend({template:_.template('<div class="task-detail-view-header-wrapper"><div class="title-wrapper"><div class="task-detail-view-title"><%- title %></div><div class="task-actions"><div class="delete-task"><a href="#"><i class="icon-trash icon-dark-purple"></i>Delete</a></div><div class="modify-task"><a href="#"><i class="icon-edit icon-dark-purple"></i>Modify Task</a></div><div class="add-time"><a href="#"><i class="icon-time icon-dark-purple"></i>Add Time</a></div></div></div><div class="task-detail-stats"><div class="header-text">Stats at a glance</div><div class="stat-text"><div class="task-frequency-text">Every 3 days</div><div class="current-streak-text">2 days</div><div class="longest-streak-text">21 days</div></div><div class="label-text"><div class="task-frequency">Goal</div><div class="current-streak">Current Streak</div><div class="longest-streak">Longest Streak</div></div></div></div><div class="detail-btn-bar-calendar clearfix"><div id="task-detail-btn-bar" class="btn-group"><button class="btn btn-large">Calendar</button><button class="btn btn-large">Stats</button></div><div id="calendar"></div><div>'),events:{},initialize:function(){},render:function(){var e=$(this.$el);return e.html(this.template(this.model.toJSON())),e.find("#calendar").datepicker({inline:!0,firstDay:1,showOtherMonths:!0,dayNamesMin:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]}),this},setModel:function(e){this.model=e,this.render()}}),u,a=Backbone.View.extend({el:$("#tasks-list-view"),initialize:function(){this.input=this.$("#new-task"),i.on("add",this.addOne,this),i.on("reset",this.addAll,this),i.fetch()},render:function(){},events:{"keypress #new-task":"createOnEnter"},addOne:function(e){var t=new s({model:e});this.$("#task-list").prepend(t.render().el)},addAll:function(){i.each(this.addOne)},createOnEnter:function(e){if(e.keyCode!==13)return;if(!this.input.val())return;i.create({title:this.input.val()}),this.input.val("")}}),f=new a,l=Backbone.Router.extend({routes:{"task/:id":"getTask","":"getAllTasks"}}),c=new l;c.on("route:getTask",function(e){$(f.el).fadeOut(200,function(){_.each(i.models,function(t){parseInt(t.get("order"),10)===parseInt(e,10)&&(u?u.setModel(t):(u=new o({model:t}),$("#task-detail-view").append(u.render().el)))}),$(".task-detail-view-container").fadeIn(200),$("#grey-bkgrnd").fadeIn(200)})}),c.on("route:getAllTasks",function(e){$("#grey-bkgrnd").fadeOut(200),$(".task-detail-view-container").fadeOut(200,function(){$(f.el).fadeIn(200)})}),Backbone.history.start(),$("#task-list").sortable({start:function(e,t){$(t.placeholder).hide(100);var n=t.item.index();t.item.data("start_pos",n)},stop:function(e,t){},forcePlaceholderSize:!0,change:function(e,t){$(t.placeholder).hide().show(100);var n=t.item.data("start_pos"),r=t.placeholder.index();n<r&&(r-=1),i.currentPlaceholderIndex=r},placeholder:{element:function(e){return $("<li></li>")[0]},update:function(e,t){e.refreshPositions(),e.placeholder.css("backgroundColor","#eff6fc"),e.placeholder.css("borderColor","#4192d7"),e.placeholder.css("height","42px");return}}}),$("#task-list").disableSelection()});