$(function(){var e=150,t=100,n="easeInQuart";window.Task=Backbone.Model.extend({defaults:function(){return{title:"default value",displayTime:"0:00:00",order:i.nextOrder(),sessions:[],totalTime:0}},initialize:function(){this.set({isRecording:!1}),this.set("displayTime","0:00:00"),this.set("totalTime",this.getTotalTime(Date.today().last().sunday().getTime()))},updateDisplayTime:function(e){this.set("displayTime",e),this.set("totalTime",this.getTotalTime(Date.today().last().sunday().getTime())),this.save()},startSession:function(){this.set({isRecording:!0}),this.set({justStopped:!1}),this.set("displayTime","0:00:00");var e=this.get("sessions"),t=this,n={totalTime:0,startDate:(new Date).getTime(),endDate:Number.MAX_VALUE,timerInterval:null,startSession:function(){var e=0,n=this;this.timerInterval=setInterval(function(){e+=1,n.totalTime=e;var r=(new Date).clearTime().addSeconds(e).toString("H:mm:ss");t.updateDisplayTime(r)},1e3)},stopSession:function(){clearInterval(this.timerInterval)}};this.set("currentSession",n),n.startSession(),e.push(n)},stopSession:function(){var e=this.get("currentSession"),t=Date.today().getTime();this.set({justStopped:!0}),e.endDate=(new Date).getTime(),e.stopSession(),this.set("totalTime",this.getTotalTime(t)),this.set({isRecording:!1}),this.set("displayTime","0:00:00"),this.set("currentSession",null),this.save()},getTotalTime:function(e){var t,n=0,r=0,i=this.get("sessions"),s=i.length;e>0&&(n=e);for(t=0;t<=s-1;t++)i[t].endDate>n&&(r+=parseInt(i[t].totalTime,10));return r},getDailyPercentage:function(){var e=10800,t=this.getTotalTime(Date.today().getTime()),n=Math.round(t/e*100)/100;return n<.05&&(n=.05),n>1&&(n=1),n*100},getWeeklyPercentage:function(){var e=68400,t=this.getTotalTime(Date.today().last().sunday().getTime());return Math.round(t/e*100)/100},matchOrderIndex:function(e){this.set("order",e),this.save()}});var r=Backbone.Collection.extend({model:window.Task,currentPlaceholderIndex:Number.MAX_VALUE,localStorage:new Backbone.LocalStorage("tasks-backbone"),nextOrder:function(){return this.length?this.last().get("order")+1:0},comparator:function(e){return e.get("order")},logStartSession:function(e){this.activeSession=e},logStopSession:function(){this.activeSession=null},stopActiveSession:function(){this.activeSession&&this.activeSession.stopSession()},updateListOrder:function(e,t){var n;_.each(this.models,function(t){t.get("order")===e&&(n=t)});if(n){this.models.splice(_.indexOf(this.models,n),1),this.models.splice(this.models.length-t,0,n);var r;for(r=0;r<=this.models.length-1;r++)this.models[r].set("order",r),this.models[r].save()}}}),i=new r,s=Backbone.View.extend({tagName:"li",template:_.template("<div class='view' id='item'><div id='item-template'><div id='task-title'><%- title %></div><div id='task-display-time'><%- displayTime %></div><div id='task-total-time'>Total time: <%- totalTime %></div><div class='ui-progress-bar blue ui-container'><div class='ui-progress'></div></div><a class='destroy'></a></div></div></div>"),events:{mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseClick",mouseenter:"onMouseOver",mouseleave:"onMouseOut"},initialize:function(){var e=$(this.$el);this.model.on("change",this.render,this),this.model.on("destroy",this.remove,this),this.hasBeenDragged=!1,this.mousedown=!1},render:function(){var e=this.$el;e.html(this.template(this.model.toJSON()));var t=$(e).find(".ui-progress"),n=$(e).find("#task-display-time"),r=this.model.getDailyPercentage();return t.width(r+"%"),this.model.get("justStopped")===!0&&(this.model.set({justStopped:!1}),this.delegateEvents(this.events),this.onMouseOut()),this.model.get("isRecording")===!0?n.show():n.hide(),this},onMouseDoubleClick:function(){window.location="/#task/"+this.model.get("order")},onMouseOut:function(){var e=$(this.$el),t=e.find("#task-display-time");e.animate({backgroundColor:"#FFFFFF"},100),e.animate({borderColor:"#CCCCCC"},100),e.css({color:"#666666"},100)},onMouseOver:function(){var e=$(this.$el);e.css({borderColor:"#9a63f5",backgroundColor:"#418fdc",color:"#F7F7F7"})},onMouseClick:function(){var e=this;this.mousedown=!1,this.alreadyClicked?(this.alreadyClicked=!1,clearTimeout(this.alreadyClickedTimeout),this.onMouseDoubleClick()):(this.alreadyClicked=!0,this.alreadyClickedTimeout=setTimeout(function(){e.alreadyClicked=!1,e.startSession()},300))},onMouseMove:function(){this.mousedown===!0&&(this.hasBeenDragged=!0)},onMouseDown:function(){this.mousedown=!0},clearDoubleClickInterval:function(){clearInterval(this.alreadyClickedTimeout)},animateSelectedTask:function(t,n){var r="#FFFFFF",i="#CCCCCC",s="#666",o="inline";n===!0&&(r="#9a63f5",i="#773fd3",s="#FFFFFF"),t.animate({backgroundColor:r},e),t.animate({color:s},10),t.css({borderColor:i})},setDraggingFalse:function(){this.isDragging=!1,this.undelegateEvents(),this.delegateEvents(this.events),this.hasBeenDragged=!0},startSession:function(){var e=i.currentPlaceholderIndex,t=this.model.get("order");if(this.model.get("isRecording")!==!0&&this.hasBeenDragged!==!0){this.undelegateEvents(),this.delegateEvents({mouseup:"stopSession"}),i.stopActiveSession(),i.logStartSession(this.model),this.model.startSession();var n=$(this.$el);this.animateSelectedTask(n,!0)}else this.hasBeenDragged===!0&&i.updateListOrder(t,e);i.currentPlaceholderIndex=Number.MAX_VALUE,this.hasBeenDragged=!1,this.mousedown=!1},stopSession:function(){if(this.model.get("isRecording")===!0){this.undelegateEvents(),this.delegateEvents(this.events),i.logStopSession(),this.model.stopSession();var e=$(this.$el);this.animateSelectedTask(e,!1)}},close:function(){},clear:function(){this.model.destroy()}}),o=Backbone.View.extend({template:_.template('<div class="task-detail-view-header-wrapper"><div class="title-wrapper"><div class="task-detail-view-title"><%- title %></div><div class="task-actions"><div class="add-time"><a class="add-time-btn" rel="popover" data-placement="right" data-original-title="Add Time to Task" href="#"><i class="icon-time icon-dark-purple"></i>Add Time</a></div><div class="modify-task"><a class="" href="#"><i class="icon-edit icon-dark-purple"></i>Edit Task</a></div><div class="delete-task"><a class="delete-task-btn" el="popover" data-placement="right" data-original-title="Confirm Task Deletion" href="#"><i class="icon-trash icon-dark-purple"></i>Delete Task</a></div></div></div><div class="task-detail-stats"><div class="header-text"><i class="icon-signal"></i>Stats at a glance</div><div class="stat-text"><div class="task-frequency-text">34 hours</div><div class="current-streak-text">3 sessions</div><div class="longest-streak-text">1.2 hours</div></div><div class="label-text"><div class="task-frequency">so far</div><div class="current-streak">recorded</div><div class="longest-streak">per session</div></div></div></div><div class="detail-btn-bar-calendar clearfix"><div id="task-detail-btn-bar" class="btn-group"><button id="calendar-tab-btn" class="btn btn-large active"><i class="icon-calendar"></i>Calendar</button><button id="stats-tab-btn" class="btn btn-large"><i class="icon-signal"></i>Stats</button></div><div id="calendar"></div><div id="charts-view-inner"></div></div>'),events:{"click .modify-task a":"onEdit","click .add-time a":"onAddTime","click .delete-task a":"onDeleteClick","click .date-picker":"onDatePicker","click #add-time-confirm-btn":"onAddTimeConfirmClick","click #add-time-cancel-btn":"onAddTimeCancelClick","click #delete-task-confirm-btn":"onDeleteConfirmationClick","click #delete-task-cancel-btn":"onDeleteCancelClick","click #calendar-tab-btn":"onCalendarTabButtonClick","click #stats-tab-btn":"onStatsTabButtonClick"},onCalendarTabButtonClick:function(e){$("#stats-tab-btn").removeClass("active"),$("#calendar-tab-btn").addClass("active"),$("#calendar").fadeIn(200),$("#charts-view").fadeOut(200)},onStatsTabButtonClick:function(e){$("#stats-tab-btn").addClass("active"),$("#calendar-tab-btn").removeClass("active"),$("#calendar").fadeOut(200),$("#charts-view").fadeIn(200)},onDatePicker:function(e){$("#dp").datepicker()},onAddTimeConfirmClick:function(e){$(".add-time-btn").popover("hide")},onAddTimeCancelClick:function(e){$(".add-time-btn").popover("hide")},onAddTime:function(e){e.preventDefault();var t=$(this.$el);t.find(".add-time-btn").popover("toggle")},onDeleteClick:function(e){e.preventDefault(),$(this.$el).find(".delete-task-btn").popover("toggle")},onDeleteConfirmationClick:function(e){e.preventDefault(),this.model.destroy(),window.location="#"},onDeleteCancelClick:function(e){e.preventDefault(),$(this.$el).find(".delete-task-btn").popover("hide")},onEdit:function(e){e.preventDefault(),window.location="#/task/edit/"+this.model.get("order")},initialize:function(){},render:function(){var e=$(this.$el);return e.html(this.template(this.model.toJSON())),e.find(".add-time-btn").popover({content:'<div class="input-append date date-picker" id="dp3" data-date="12-02-2013" data-date-format="mm-dd-yyyy"><input class="span2" id="dp" type="text"><span class="add-on"><i class="icon-calendar"></i></span></div><div class="input-append"><input class="span2" type="text" id="appendedInput" placeholder="Hours"><span class="add-on">hours</span></div><div class="input-append"><input class="span2" type="text" id="appendedInput" placeholder="Minutes"><span class="add-on">minutes</span></div><button id="add-time-confirm-btn"class="btn btn-success">Confirm</button><button id="add-time-cancel-btn" class="btn">Cancel</button>',html:!0}),e.find(".delete-task-btn").popover({content:'<button id="delete-task-confirm-btn" class="btn btn-success">Confirm</button><button id="delete-task-cancel-btn" class="btn">Cancel</button>',html:!0}),this.chartView||(this.chartView=new a,$("#charts-view-inner").append(this.chartView.render().el)),$("#charts-view").hide(),e.find("#calendar").datepicker({inline:!0,firstDay:1,showOtherMonths:!0,dayNamesMin:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],isRolloverCalendar:!0,rolloverTitle:"Stats",onRefreshFunction:this.onCalendarRefresh,element:e,model:this.model}),e.find("#calendar td a").live("mouseleave",function(){$(this).popover("hide")}),e.find("#calendar td a").live("mouseenter",function(){$(this).popover("show")}),console.log("model: "+JSON.stringify(this.model)),this.onCalendarRefresh(e,this.model),this},onCalendarRefresh:function(e,t){$("#calendar td").addClass("ui-datepicker-unselectable");if(t!==undefined){var n=[],r=Date.getMonthNumberFromName($(".ui-datepicker-month").text()),i=parseInt($(".ui-datepicker-year").text(),10),s;r<0&&(r=(new Date).getMonth()),i||(i=(new Date).getFullYear());for(s=0;s<=t.get("sessions").length-1;s++){var o=new Date(parseInt(t.get("sessions")[s].startDate,10));o.getMonth()===r&&o.getFullYear()===i&&n.push(o)}for(s=0;s<=n.length-1;s++)e.find("#calendar td a").filter(function(){return parseInt($(this).text(),10)===n[s].getDate()}).addClass("calendar-stopwatch").attr("el","popover").attr("data-original-title","Stats").attr("data-placement","top")}},setModel:function(e){this.model=e,this.render()}}),u,a=Backbone.View.extend({el:$("#charts-view"),events:{},initialize:function(){this.r=new Raphael(this.el,620,500)},render:function(){return this.r.barchart(0,0,620,260,[76,70,67,71,69,21,33],{colors:["#9a63f5","#9a63f5","#9a63f5","#9a63f5","#9a63f5","#9a63f5","#9a63f5"]}),this}}),f=Backbone.View.extend({template:_.template('<p class="section-heading">Edit Task</p><form><p class="form-label">Task Name:</p><input class="input-xlarge" type="text" placeholder="<%- title %>"><p class="form-label">How often would you like to repeat this task?</p><div class="btn-toolbar"><div class="btn-group"><button class="btn">S</button><button class="btn">M</button><button class="btn active">T</button><button class="btn">W</button><button class="btn">T</button><button class="btn">F</button><button class="btn">S</button></div></div><p class="form-label">Intervals</p><div class="checkbox-section"><label class="checkbox"><input type="checkbox" id="intervalOption1">Every day</label><label class="checkbox"><input type="checkbox" id="intervalOption2">Every 2 days</label><label class="checkbox"><input type="checkbox" id="intervalOption3">Every 2-3 days</label><label class="checkbox"><input type="checkbox" id="intervalOption4">Every 3 days</label><label class="checkbox"><input type="checkbox" id="intervalOption5">Every 3-5 days</label></div><p class="form-label">Non-specific days</p><div class="checkbox-section nonspecific"><label class="checkbox"><input type="checkbox" id="nonSpecificOption1">1 day per week</label><label class="checkbox"><input type="checkbox" id="nonSpecificOption2">2 days per week</label><label class="checkbox"><input type="checkbox" id="nonSpecificOption3">3 days per week</label><label class="checkbox"><input type="checkbox" id="nonSpecificOption4">4 days per week</label><label class="checkbox"><input type="checkbox" id="nonSpecificOption5">5 days per week</label><label class="checkbox"><input type="checkbox" id="nonSpecificOption6">6 days per week</label></div><p><button class="btn">Save</button><button class="btn">Cancel</button></p></form>'),events:{},initialize:function(){},render:function(){var e=$(this.$el);return e.html(this.template(this.model.toJSON())),this},setModel:function(e){this.model=e,this.render()}}),l,c=Backbone.View.extend({el:$("#tasks-list-view"),initialize:function(){this.input=this.$("#new-task"),i.on("add",this.addOne,this),i.on("reset",this.addAll,this),i.fetch()},render:function(){},events:{"keypress #new-task":"createOnEnter"},addOne:function(e){var t=new s({model:e});this.$("#task-list").prepend(t.render().el)},addAll:function(){i.each(this.addOne)},createOnEnter:function(e){if(e.keyCode!==13)return;if(!this.input.val())return;i.create({title:this.input.val()}),this.input.val("")}}),h=new c,p=Backbone.Router.extend({routes:{"":"getAllTasks","task/:id":"getTask","task/edit/:id":"editTask"}}),d=new p;d.on("route:getTask",function(e){var t=$("#tasks-list-view").is(":visible")?$("#tasks-list-view"):$(".edit-task-view-container");t.fadeOut(200,function(){_.each(i.models,function(t){parseInt(t.get("order"),10)===parseInt(e,10)&&(u?u.setModel(t):(u=new o({model:t}),$("#task-detail-view").append(u.render().el)))}),$(".task-detail-view-container").fadeIn(200),$("#grey-bkgrnd").fadeIn(200),$("#grey-bkgrnd").height($(".main").height())}),$("#grey-bkgrnd").animate({marginTop:165},300),$(".alerts").fadeOut(0),$(".delete-task-alert").fadeOut(0)}),d.on("route:getAllTasks",function(e){$("#grey-bkgrnd").fadeOut(200);var t=$(".task-detail-view-container").is(":visible")?$(".task-detail-view-container"):$(".edit-task-view-container");t.fadeOut(200,function(){$(h.el).fadeIn(200)}),$(".alerts").fadeOut(0),$(".delete-task-alert").fadeOut(0)}),d.on("route:editTask",function(e){var t=$(".task-detail-view-container").is(":visible")?$(".task-detail-view-container"):$("#tasks-list-view");t.fadeOut(200,function(){_.each(i.models,function(t){parseInt(t.get("order"),10)===parseInt(e,10)&&(l?l.setModel(t):(l=new f({model:t}),$("#edit-task-view").append(l.render().el)))}),$(".edit-task-view-container").fadeIn(200),$("#grey-bkgrnd").fadeIn(200),$("#grey-bkgrnd").height($(".main").height())}),$("#grey-bkgrnd").animate({marginTop:98},300),$(".alerts").fadeOut(0),$(".delete-task-alert").fadeOut(0)}),Backbone.history.start(),$("#task-list").sortable({start:function(e,t){$(t.placeholder).hide(100);var n=t.item.index();t.item.data("start_pos",n)},stop:function(e,t){},forcePlaceholderSize:!0,change:function(e,t){$(t.placeholder).hide().show(100);var n=t.item.data("start_pos"),r=t.placeholder.index();n<r&&(r-=1),i.currentPlaceholderIndex=r},placeholder:{element:function(e){return $("<li></li>")[0]},update:function(e,t){e.refreshPositions(),e.placeholder.css("backgroundColor","#eff6fc"),e.placeholder.css("borderColor","#4192d7"),e.placeholder.css("height","42px");return}}}),$("#grey-bkgrnd").height($(".main").height()),$("#grey-bkgrnd").width($(".main").width()),$(window).resize(function(){$("#grey-bkgrnd").height($(".main").height()),$("#grey-bkgrnd").width($(".main").width())}),$("#task-list").disableSelection()});