$(function(){function m(e){if(e===0)return"0 hours";var t,n=Math.floor(e/3600*100/100);return n<1?(n=Math.floor(e/60*100/100),n<1?(n=e,n+=n===1?" second":" seconds",n):(n+=n===1?" minute":" minutes",n)):(n+=n===1?" hour":" hours",n)}var e=150,t=100,n="easeInQuart";window.Task=Backbone.Model.extend({defaults:function(){return{title:"default value",displayTime:"0:00:00",order:s.nextOrder(),sessions:[],totalTime:0}},initialize:function(){this.set({isRecording:!1}),this.set("displayTime","0:00:00"),this.set("totalTime",this.getTotalTime(Date.today().last().sunday().getTime()))},updateDisplayTime:function(e){this.set("displayTime",e),this.set("totalTime",this.getTotalTime(Date.today().last().sunday().getTime())),this.save()},startSession:function(){this.set({isRecording:!0}),this.set({justStopped:!1}),this.set("displayTime","0:00:00");var e=this.get("sessions"),t=this,n={totalTime:0,startDate:(new Date).getTime(),endDate:Number.MAX_VALUE,timerInterval:null,startSession:function(){var e=0,n=this;this.timerInterval=setInterval(function(){e+=1,n.totalTime=e;var r=(new Date).clearTime().addSeconds(e).toString("H:mm:ss");t.updateDisplayTime(r)},1e3)},stopSession:function(){clearInterval(this.timerInterval)}};this.set("currentSession",n),n.startSession(),e.push(n)},stopSession:function(){var e=this.get("currentSession"),t=Date.today().getTime();this.set({justStopped:!0}),e.endDate=(new Date).getTime(),e.stopSession(),this.set("totalTime",this.getTotalTime(t)),this.set({isRecording:!1}),this.set("displayTime","0:00:00"),this.set("currentSession",null),this.save()},addSession:function(e){var t=this.get("sessions");t.push(e),this.set("sessions",t),this.set("lastSessionAdded",e),this.set("lastSessionAdded",null),this.save()},getTotalTime:function(e){var t,n=0,r=0,i=this.get("sessions"),s=i.length;e>0&&(n=e);for(t=0;t<=s-1;t++)i[t].endDate>n&&(r+=parseInt(i[t].totalTime,10));return r},getDailyPercentage:function(){var e=10800,t=this.getTotalTime(Date.today().getTime()),n=Math.round(t/e*100)/100;return n<.05&&(n=.05),n>1&&(n=1),n*100},getWeeklyPercentage:function(){var e=68400,t=this.getTotalTime(Date.today().last().sunday().getTime());return Math.round(t/e*100)/100},matchOrderIndex:function(e){this.set("order",e),this.save()}});var r=Backbone.Collection.extend({model:window.Task,currentPlaceholderIndex:Number.MAX_VALUE,localStorage:new Backbone.LocalStorage("tasks-backbone"),nextOrder:function(){return this.length?this.last().get("order")+1:0},comparator:function(e){return e.get("order")},logStartSession:function(e){this.activeSession=e},logStopSession:function(){this.activeSession=null},stopActiveSession:function(){this.activeSession&&this.activeSession.stopSession()},updateListOrder:function(e,t){var n;_.each(this.models,function(t){t.get("order")===e&&(n=t)});if(n){this.models.splice(_.indexOf(this.models,n),1),this.models.splice(this.models.length-t,0,n);var r;for(r=0;r<=this.models.length-1;r++)this.models[r].set("order",r),this.models[r].save()}}}),s=new r,o=Backbone.View.extend({tagName:"li",template:_.template("<div class='view' id='item'><div id='item-template'><div id='task-title'><%- title %></div><div id='task-display-time'><%- displayTime %></div><div id='task-total-time'>Total time: <%- totalTime %></div><div class='ui-progress-bar blue ui-container'><div class='ui-progress'></div></div><a class='destroy'></a></div></div></div>"),events:{mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseClick",mouseenter:"onMouseOver",mouseleave:"onMouseOut"},initialize:function(){this.model.on("change",this.render,this),this.model.on("destroy",this.remove,this),this.hasBeenDragged=!1,this.mousedown=!1},render:function(){var e=this.$el;e.html(this.template(this.model.toJSON()));var t=$(e).find(".ui-progress"),n=$(e).find("#task-display-time"),r=this.model.getDailyPercentage();return t.width(r+"%"),this.model.get("justStopped")===!0&&(this.model.set({justStopped:!1}),this.delegateEvents(this.events),this.onMouseOut()),this.model.get("isRecording")===!0?n.show():n.hide(),this},onMouseDoubleClick:function(){window.location="/#task/"+this.model.get("order")},onMouseOut:function(){var e=$(this.$el),t=e.find("#task-display-time");e.animate({backgroundColor:"#FFFFFF"},100),e.animate({borderColor:"#CCCCCC"},100),e.css({color:"#666666"},100)},onMouseOver:function(){var e=$(this.$el);e.css({borderColor:"#9a63f5",backgroundColor:"#418fdc",color:"#F7F7F7"})},onMouseClick:function(){var e=this;this.mousedown=!1,this.alreadyClicked?(this.alreadyClicked=!1,clearTimeout(this.alreadyClickedTimeout),this.onMouseDoubleClick()):(this.alreadyClicked=!0,this.alreadyClickedTimeout=setTimeout(function(){e.alreadyClicked=!1,e.startSession()},300))},onMouseMove:function(){this.mousedown===!0&&(this.hasBeenDragged=!0)},onMouseDown:function(){this.mousedown=!0},clearDoubleClickInterval:function(){clearInterval(this.alreadyClickedTimeout)},animateSelectedTask:function(t,n){var r="#FFFFFF",i="#CCCCCC",s="#666",o="inline";n===!0&&(r="#9a63f5",i="#773fd3",s="#FFFFFF"),t.animate({backgroundColor:r},e),t.animate({color:s},10),t.css({borderColor:i})},setDraggingFalse:function(){this.isDragging=!1,this.undelegateEvents(),this.delegateEvents(this.events),this.hasBeenDragged=!0},startSession:function(){var e=s.currentPlaceholderIndex,t=this.model.get("order");if(this.model.get("isRecording")!==!0&&this.hasBeenDragged!==!0){this.undelegateEvents(),this.delegateEvents({mouseup:"stopSession"}),s.stopActiveSession(),s.logStartSession(this.model),this.model.startSession();var n=$(this.$el);this.animateSelectedTask(n,!0)}else this.hasBeenDragged===!0&&s.updateListOrder(t,e);s.currentPlaceholderIndex=Number.MAX_VALUE,this.hasBeenDragged=!1,this.mousedown=!1},stopSession:function(){if(this.model.get("isRecording")===!0){this.undelegateEvents(),this.delegateEvents(this.events),s.logStopSession(),this.model.stopSession();var e=$(this.$el);this.animateSelectedTask(e,!1)}},close:function(){},clear:function(){this.model.destroy()}}),u=Backbone.View.extend({template:_.template('<div class="task-detail-view-header-wrapper"><div class="title-wrapper"><div class="task-detail-view-title"><%- title %></div><div class="task-actions"><div class="add-time"><a class="add-time-btn" rel="popover" data-placement="right" data-original-title="Add Time to Task" href="#"><i class="icon-time icon-dark-purple"></i>Add Time</a></div><div class="modify-task"><a class="" href="#"><i class="icon-edit icon-dark-purple"></i>Edit Task</a></div><div class="delete-task"><a class="delete-task-btn" el="popover" data-placement="right" data-original-title="Confirm Task Deletion" href="#"><i class="icon-trash icon-dark-purple"></i>Delete Task</a></div></div></div><div class="task-detail-stats"><div class="header-text"><i class="icon-signal"></i>Stats at a glance</div><div class="stat-text"><div class="total-hours-text">34 hours</div><div class="sessions-recorded-text">3 sessions</div><div class="daily-goal-text">1 hour</div></div><div class="label-text"><div class="total-hours">so far</div><div class="sessions-recorded">recorded</div><div class="daily-goal">daily goal</div></div></div></div><div class="detail-btn-bar-calendar clearfix"><div id="task-detail-btn-bar" class="btn-group"><button id="calendar-tab-btn" class="btn btn-large active"><i class="icon-calendar"></i>Calendar</button><button id="stats-tab-btn" class="btn btn-large"><i class="icon-signal"></i>Stats</button></div><div id="calendar"></div><div id="charts-view-inner"></div></div>'),events:{"click .modify-task a":"onEdit","click .add-time a":"onAddTime","click .delete-task a":"onDeleteClick","click .date-picker":"onDatePicker","click #add-time-confirm-btn":"onAddTimeConfirmClick","click #add-time-cancel-btn":"onAddTimeCancelClick","click #delete-task-confirm-btn":"onDeleteConfirmationClick","click #delete-task-cancel-btn":"onDeleteCancelClick","click #calendar-tab-btn":"onCalendarTabButtonClick","click #stats-tab-btn":"onStatsTabButtonClick"},onCalendarTabButtonClick:function(e){$("#stats-tab-btn").removeClass("active"),$("#calendar-tab-btn").addClass("active"),$("#calendar").fadeIn(200),$("#charts-view").fadeOut(200)},onStatsTabButtonClick:function(e){$("#stats-tab-btn").addClass("active"),$("#calendar-tab-btn").removeClass("active"),$("#calendar").fadeOut(200),$("#charts-view").fadeIn(200)},onDatePicker:function(e){$("#dp").datepicker()},onAddTimeConfirmClick:function(e){var t=$(this.$el),n=t.find(".add-time-hours").val()*3600+t.find(".add-time-minutes").val()*60,r=Date.parse(t.find(".add-time-date").val()),i={totalTime:n,startDate:r.getTime(),endDate:r.getTime()+n};i&&this.model.addSession(i),$(".add-time-btn").popover("hide")},onAddTimeCancelClick:function(e){$(".add-time-btn").popover("hide")},onAddTime:function(e){e.preventDefault();var t=$(this.$el);t.find(".add-time-btn").popover("toggle")},onDeleteClick:function(e){e.preventDefault(),$(this.$el).find(".delete-task-btn").popover("toggle")},onDeleteConfirmationClick:function(e){e.preventDefault(),this.model.destroy(),window.location="#"},onDeleteCancelClick:function(e){e.preventDefault(),$(this.$el).find(".delete-task-btn").popover("hide")},onEdit:function(e){e.preventDefault(),window.location="#/task/edit/"+this.model.get("order")},initialize:function(){},modelChanged:function(){window.location="#task/refresh-detail/"+this.model.get("order")},render:function(){var e=$(this.$el);return e.html(this.template(this.model.toJSON())),this.model.on("change",this.modelChanged,this),e.find(".add-time-btn").popover({content:'<div class="input-append date date-picker" id="dp3" data-date="12-02-2013" data-date-format="mm-dd-yyyy"><input class="span2 add-time-date" id="dp" type="text"><span class="add-on"><i class="icon-calendar"></i></span></div><div class="input-append"><input class="span2 add-time-hours" type="text" id="appendedInput" placeholder="Hours"><span class="add-on">hours</span></div><div class="input-append"><input class="span2 add-time-minutes" type="text" id="appendedInput" placeholder="Minutes"><span class="add-on">minutes</span></div><button id="add-time-confirm-btn"class="btn btn-success">Confirm</button><button id="add-time-cancel-btn" class="btn">Cancel</button>',html:!0}),e.find(".delete-task-btn").popover({content:'<button id="delete-task-confirm-btn" class="btn btn-success">Confirm</button><button id="delete-task-cancel-btn" class="btn">Cancel</button>',html:!0}),typeof this.chartView=="undefined"&&(this.chartView=new f({model:this.model}),$("#charts-view-inner").append(this.chartView.render().el)),e.find(".total-hours-text").text(m(this.model.getTotalTime())),e.find(".sessions-recorded-text").text(this.model.get("sessions").length+" sessions"),$("#charts-view").hide(),e.find("#calendar").datepicker({inline:!0,firstDay:1,showOtherMonths:!0,dayNamesMin:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],isRolloverCalendar:!0,rolloverTitle:"Stats",onRefreshFunction:this.onCalendarRefresh,element:e,model:this.model,view:this}),console.debug("model: "+JSON.stringify(this.model)),this.onCalendarRefresh(e,this.model,this),this},onCalendarRefresh:function(e,t,n){$("#calendar td").addClass("ui-datepicker-unselectable");if(t!==undefined){var r=[],i=Date.getMonthNumberFromName($(".ui-datepicker-month").text()),s=parseInt($(".ui-datepicker-year").text(),10),o;i<0&&(i=(new Date).getMonth()),s||(s=(new Date).getFullYear());for(o=0;o<=t.get("sessions").length-1;o++){var u=new Date(parseInt(t.get("sessions")[o].startDate,10));u.getMonth()===i&&u.getFullYear()===s&&r.push(u)}for(o=0;o<=r.length-1;o++)e.find("#calendar td a").filter(function(){return parseInt($(this).text(),10)===r[o].getDate()}).addClass("calendar-stopwatch").attr("el","popover").attr("data-placement","top");e.find("#calendar td a").on("mouseleave",n.onCalendarDateMouseLeave),e.find("#calendar td a").on("mouseenter",{model:t,view:n},n.onCalendarDateMouseEnter)}},onCalendarDateMouseEnter:function(e){var t=[],n=$(e.data.view.$el),r=Date.getMonthNumberFromName(n.find(".ui-datepicker-month").text()),s=parseInt(n.find(".ui-datepicker-year").text(),10),o=parseInt($(this).text(),10),u=0;for(i=0;i<=e.data.model.get("sessions").length-1;i++){var a=new Date(parseInt(e.data.model.get("sessions")[i].startDate,10));a.getMonth()===r&&a.getFullYear()===s&&a.getDate()===o&&(t.push(a),u+=e.data.model.get("sessions")[i].totalTime)}t.length>0&&($(this).popover({title:n.find(".ui-datepicker-month").text()+" "+$(this).text()+", "+n.find(".ui-datepicker-year").text(),content:'<div class="popover-content"><p>'+m(u)+" recorded</p><p>"+t.length+" sessions</p></div>",html:!0}),$(this).popover("show"))},onCalendarDateMouseLeave:function(e){$(this).popover("hide")},setModel:function(e){this.model=e},close:function(){var e=$(this.$el);e.find("#calendar").datepicker("destroy"),e.find("#calendar td a").unbind("mouseleave",this.onCalendarDateMouseLeave),e.find("#calendar td a").unbind("mouseenter",{model:this.model},this.onCalendarDateMouseEnter),this.chartView.close(),this.chartView=null,this.remove(),this.unbind(),this.model.unbind("change",this.modelChanged)}}),a,f=Backbone.View.extend({el:$("#charts-view #chart-holder"),template:_.template(""),events:{},onPreviousWeekClick:function(e){e.preventDefault(),e.data.view.onWeekChange(e.data.view,-6)},onNextWeekClick:function(e){e.preventDefault(),e.data.view.onWeekChange(e.data.view,6)},onWeekChange:function(e,t){$(e.$el).fadeOut(100,function(){e.r.remove(),e.r=null,e.r=new Raphael(e.el,542,260),Date.parse(e.firstDayOfWeek).add(t).days(),e.render()})},initialize:function(e){this.r=new Raphael(this.el,542,260),this.now=new Date,this.weekNumber=Date.today().getWeek(),this.firstDayOfWeek=Date.today().setWeek(this.weekNumber)},render:function(){var e=$(this.$el).parent(),t=this.firstDayOfWeek,n=this,r=function(){this.flag=n.r.popup(this.bar.x,this.bar.y,this.bar.value||"0").insertBefore(this),console.log("this.flag.y: "+this.flag.y)},i=function(){this.flag.animate({opacity:0},300,function(){this.remove()})},s=this.model.get("sessions"),o,u,a=[],f=0;for(o=0;o<=6;o++){var l=t.add(o===0?0:1).days();totalTime=0;for(u=0;u<=s.length-1;u++){var c=new Date(parseInt(s[u].startDate,10));c.getMonth()===l.getMonth()&&c.getFullYear()===l.getFullYear()&&c.getDate()===l.getDate()&&(totalTime+=s[u].totalTime)}f+=totalTime,a.push(totalTime)}t.add(-6).days();var h='<div id="chart-label-div"><div id="chart-header"><a href="#" id="previous-week"><i class="icon-arrow-left"></i></a>Week of '+t.toString("MM/dd/yy")+'<a href="#" id="next-week"><i class="icon-arrow-right"></i></a></div><div id="chart-date-label-container"><div id="chart-date-monday" class="chart-date-label"><span>Mon '+t.toString("MM/dd")+"- "+m(a[0])+'</span></div><div id="chart-date-tuesday" class="chart-date-label inline-label"><span>Tue '+t.add(1).days().toString("MM/dd")+"- "+m(a[1])+'</span></div><div id="chart-date-wednesday" class="chart-date-label inline-label"><span>Wed '+t.add(1).days().toString("MM/dd")+"- "+m(a[2])+'</span></div><div id="chart-date-thursday" class="chart-date-label inline-label"><span>Thu '+t.add(1).days().toString("MM/dd")+"- "+m(a[3])+'</span></div><div id="chart-date-friday" class="chart-date-label inline-label"><span>Fri '+t.add(1).days().toString("MM/dd")+"- "+m(a[4])+'</span></div><div id="chart-date-saturday" class="chart-date-label inline-label"><span>Sat '+t.add(1).days().toString("MM/dd")+"- "+m(a[5])+'</span></div><div id="chart-date-sunday" class="chart-date-label inline-label"><span>Sun '+t.add(1).days().toString("MM/dd")+"- "+m(a[6])+'</span></div></div><div id="chart-footer"></div></div>';return t.add(-6).days(),e.find("#chart-label-div").remove(),this.r.barchart(0,0,542,260,[a[0],a[1],a[2],a[3],a[4],a[5],a[6]],{colors:["#9a63f5","#9a63f5","#9a63f5","#9a63f5","#9a63f5","#9a63f5","#9a63f5"],type:"soft"}).hover(r,i),$(n.$el).fadeIn(200),e.append(h),e.find("#previous-week").on("click",{view:this},this.onPreviousWeekClick),e.find("#next-week").on("click",{view:this},this.onNextWeekClick),e.find("#chart-footer").text(m(f)+" this week"),this},close:function(){var e=$(this.$el).parent();e.find("#chart-label-div").remove(),this.r.remove(),this.r=null}}),l=Backbone.View.extend({template:_.template('<p class="section-heading">Edit Task</p><form><p class="form-label">Task Name:</p><input class="input-xlarge" type="text" placeholder="<%- title %>"><p class="form-label">How often would you like to repeat this task?</p><div class="btn-toolbar"><div class="btn-group"><button class="btn">S</button><button class="btn">M</button><button class="btn active">T</button><button class="btn">W</button><button class="btn">T</button><button class="btn">F</button><button class="btn">S</button></div></div><p class="form-label">Intervals</p><div class="checkbox-section"><label class="checkbox"><input type="checkbox" id="intervalOption1">Every day</label><label class="checkbox"><input type="checkbox" id="intervalOption2">Every 2 days</label><label class="checkbox"><input type="checkbox" id="intervalOption3">Every 2-3 days</label><label class="checkbox"><input type="checkbox" id="intervalOption4">Every 3 days</label><label class="checkbox"><input type="checkbox" id="intervalOption5">Every 3-5 days</label></div><p class="form-label">Non-specific days</p><div class="checkbox-section nonspecific"><label class="checkbox"><input type="checkbox" id="nonSpecificOption1">1 day per week</label><label class="checkbox"><input type="checkbox" id="nonSpecificOption2">2 days per week</label><label class="checkbox"><input type="checkbox" id="nonSpecificOption3">3 days per week</label><label class="checkbox"><input type="checkbox" id="nonSpecificOption4">4 days per week</label><label class="checkbox"><input type="checkbox" id="nonSpecificOption5">5 days per week</label><label class="checkbox"><input type="checkbox" id="nonSpecificOption6">6 days per week</label></div><p><button class="btn">Save</button><button class="btn">Cancel</button></p></form>'),events:{},initialize:function(){},render:function(){var e=$(this.$el);return e.html(this.template(this.model.toJSON())),this},setModel:function(e){this.model=e,this.render()}}),c,h=Backbone.View.extend({el:$("#tasks-list-view"),initialize:function(){this.input=this.$("#new-task"),s.on("add",this.addOne,this),s.on("reset",this.addAll,this),s.fetch()},render:function(){},events:{"keypress #new-task":"createOnEnter"},addOne:function(e){var t=new o({model:e});this.$("#task-list").prepend(t.render().el)},addAll:function(){s.each(this.addOne)},createOnEnter:function(e){if(e.keyCode!==13)return;if(!this.input.val())return;s.create({title:this.input.val()}),this.input.val("")}}),p=new h,d=Backbone.Router.extend({routes:{"":"getAllTasks","task/:id":"getTask","task/edit/:id":"editTask","task/refresh-detail/:id":"refreshDetail"}}),v=new d;v.on("route:getTask",function(e){if($(".task-detail-view-container").is(":visible")){a&&(a.close(),a=null),_.each(s.models,function(t){parseInt(t.get("order"),10)===parseInt(e,10)&&(a=new u({model:t}),$("#task-detail-view").append(a.render().el))});return}var t=$("#tasks-list-view").is(":visible")?$("#tasks-list-view"):$(".edit-task-view-container");t.fadeOut(200,function(){_.each(s.models,function(t){parseInt(t.get("order"),10)===parseInt(e,10)&&(a&&(a.close(),a=null),a=new u({model:t}),$("#task-detail-view").append(a.render().el))}),$(".task-detail-view-container").fadeIn(200),$("#grey-bkgrnd").fadeIn(200),$("#grey-bkgrnd").height($(".main").height())}),$("#grey-bkgrnd").animate({marginTop:165},300),$(".alerts").fadeOut(0),$(".delete-task-alert").fadeOut(0)}),v.on("route:refreshDetail",function(e){window.location="#/task/"+e}),v.on("route:getAllTasks",function(e){$("#grey-bkgrnd").fadeOut(200);var t=$(".task-detail-view-container").is(":visible")?$(".task-detail-view-container"):$(".edit-task-view-container");t.fadeOut(200,function(){$(p.el).fadeIn(200),typeof a!="undefined"&&(a.close(),a=null)}),$(".alerts").fadeOut(0),$(".delete-task-alert").fadeOut(0)}),v.on("route:editTask",function(e){var t=$(".task-detail-view-container").is(":visible")?$(".task-detail-view-container"):$("#tasks-list-view");t.fadeOut(200,function(){_.each(s.models,function(t){parseInt(t.get("order"),10)===parseInt(e,10)&&(c?c.setModel(t):(c=new l({model:t}),$("#edit-task-view").append(c.render().el)))}),$(".edit-task-view-container").fadeIn(200),$("#grey-bkgrnd").fadeIn(200),$("#grey-bkgrnd").height($(".main").height())}),$("#grey-bkgrnd").animate({marginTop:98},300),$(".alerts").fadeOut(0),$(".delete-task-alert").fadeOut(0)}),Backbone.history.start(),$("#task-list").sortable({start:function(e,t){$(t.placeholder).hide(100);var n=t.item.index();t.item.data("start_pos",n)},stop:function(e,t){},forcePlaceholderSize:!0,change:function(e,t){$(t.placeholder).hide().show(100);var n=t.item.data("start_pos"),r=t.placeholder.index();n<r&&(r-=1),s.currentPlaceholderIndex=r},placeholder:{element:function(e){return $("<li></li>")[0]},update:function(e,t){e.refreshPositions(),e.placeholder.css("backgroundColor","#eff6fc"),e.placeholder.css("borderColor","#4192d7"),e.placeholder.css("height","42px");return}}}),$("#grey-bkgrnd").height($(".main").height()),$("#grey-bkgrnd").width($(".main").width()),$(window).resize(function(){$("#grey-bkgrnd").height($(".main").height()),$("#grey-bkgrnd").width($(".main").width())}),$("#task-list").disableSelection()});