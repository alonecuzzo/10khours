$(function(){function p(e,t){var n=0,r=0;if(e<t)r=t-e;else if(t<e)r=e-t;else if(t===e)return;d(n,r,e,t)}function d(e,r,i,s){console.debug(">>>> Do swapping");var o=$("ul").children(),u=i<s,a=i+e,f=i+e+1;u||(a=i-e-1,f=i-e);var l=o.eq(a),c=o.eq(f);v(l,c,u,t,n,function(){e++;if(e>=r)return;d(e,r,i,s)})}function v(e,t,n,r,i,s){var o=e.outerHeight();n?e.css("z-index","999"):t.css("z-index","999"),e.animate({top:o},{duration:r,queue:!1,easing:i,complete:function(){n?e.insertAfter(t):t.insertBefore(e),m(e),m(t),s()}}),t.animate({top:-o},{duration:r,queue:!1,easing:i})}function m(e){e.css({position:"static",top:"0"}),e.css("z-index","0")}var e=150,t=100,n="easeInQuart",r=Backbone.Model.extend({defaults:function(){return{title:"default value",displayTime:"0:00:00",order:s.nextOrder(),sessions:[],totalTime:0}},initialize:function(){this.set({isRecording:!1}),this.set("displayTime","0:00:00"),this.set("totalTime",this.getTotalTime(Date.today().last().sunday().getTime()))},updateDisplayTime:function(e){this.set("displayTime",e),this.set("totalTime",this.getTotalTime(Date.today().last().sunday().getTime())),this.save()},startSession:function(){this.set({isRecording:!0}),this.set({justStopped:!1}),this.set("displayTime","0:00:00");var e=this.get("sessions"),t=this,n={totalTime:0,startDate:(new Date).getTime(),endDate:Number.MAX_VALUE,timerInterval:null,startSession:function(){var e=0,n=this;this.timerInterval=setInterval(function(){e+=1,n.totalTime=e;var r=(new Date).clearTime().addSeconds(e).toString("H:mm:ss");t.updateDisplayTime(r)},1e3)},stopSession:function(){clearInterval(this.timerInterval)}};this.set("currentSession",n),n.startSession(),e.push(n)},stopSession:function(){var e=this.get("currentSession"),t=Date.today().getTime();this.set({justStopped:!0}),e.endDate=(new Date).getTime(),e.stopSession(),this.set("totalTime",this.getTotalTime(t)),this.set({isRecording:!1}),this.set("displayTime","0:00:00"),this.save()},getTotalTime:function(e){var t,n=0,r=0,i=this.get("sessions"),s=i.length;e>0&&(n=e);for(t=0;t<=s-1;t++)i[t].endDate>n&&(r+=parseInt(i[t].totalTime,10));return r},getDailyPercentage:function(){var e=10800,t=this.getTotalTime(Date.today().getTime()),n=Math.round(t/e*100)/100;return n<.05&&(n=.05),n>1&&(n=1),n*100},getWeeklyPercentage:function(){var e=68400,t=this.getTotalTime(Date.today().last().sunday().getTime());return Math.round(t/e*100)/100},matchOrderIndex:function(e){this.set("order",e),this.save()}}),i=Backbone.Collection.extend({model:r,currentPlaceholderIndex:Number.MAX_VALUE,localStorage:new Backbone.LocalStorage("tasks-backbone"),nextOrder:function(){return this.length?this.last().get("order")+1:0},comparator:function(e){return e.get("order")},logStartSession:function(e){this.activeSession=e},logStopSession:function(){this.activeSession=null},stopActiveSession:function(){this.activeSession&&this.activeSession.stopSession()},updateListOrder:function(e,t){var n;_.each(this.models,function(t){t.get("order")===e&&(n=t)});if(n){this.models.splice(_.indexOf(this.models,n),1),this.models.splice(this.models.length-t,0,n);var r;for(r=0;r<=this.models.length-1;r++)this.models[r].set("order",r),this.models[r].save()}}}),s=new i,o=Backbone.View.extend({tagName:"li",template:_.template("<div class='view' id='item'><div id='item-template'><div id='task-title'><%- title %></div><div id='task-display-time'><%- displayTime %></div><div id='task-total-time'>Total time: <%- totalTime %></div><div class='ui-progress-bar blue ui-container'><div class='ui-progress'></div></div><a class='destroy'></a></div><input type='text' class='edit' value='' name='' /></div></div>"),events:{mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseClick",mouseenter:"onMouseOver",mouseleave:"onMouseOut"},initialize:function(){var e=$(this.$el);this.model.on("change",this.render,this),this.hasBeenDragged=!1,this.mousedown=!1},render:function(){var e=this.$el;e.html(this.template(this.model.toJSON()));var t=$(e).find(".ui-progress"),n=$(e).find("#task-display-time"),r=this.model.getDailyPercentage();return t.width(r+"%"),this.model.get("justStopped")===!0&&(this.model.set({justStopped:!1}),this.delegateEvents(this.events),this.onMouseOut()),this.model.get("isRecording")===!0?n.show():n.hide(),this},onMouseDoubleClick:function(){window.location="http://localhost:4567/#task/"+this.model.get("order")},onMouseOut:function(){var e=$(this.$el),t=e.find("#task-display-time");e.animate({backgroundColor:"#FFFFFF"},100),e.animate({borderColor:"#CCCCCC"},100),e.css({color:"#666666"},100)},onMouseOver:function(){var e=$(this.$el);e.css({borderColor:"#9a63f5",backgroundColor:"#418fdc",color:"#F7F7F7"})},onMouseClick:function(){var e=this;this.mousedown=!1,this.alreadyClicked?(this.alreadyClicked=!1,clearTimeout(this.alreadyClickedTimeout),this.onMouseDoubleClick()):(this.alreadyClicked=!0,this.alreadyClickedTimeout=setTimeout(function(){e.alreadyClicked=!1,e.startSession()},300))},onMouseMove:function(){this.mousedown===!0&&(this.hasBeenDragged=!0)},onMouseDown:function(){this.mousedown=!0},clearDoubleClickInterval:function(){clearInterval(this.alreadyClickedTimeout)},animateSelectedTask:function(t,n){var r="#FFFFFF",i="#CCCCCC",s="#666",o="inline";n===!0&&(r="#9a63f5",i="#773fd3",s="#FFFFFF"),t.animate({backgroundColor:r},e),t.animate({color:s},10),t.css({borderColor:i})},setDraggingFalse:function(){this.isDragging=!1,this.undelegateEvents(),this.delegateEvents(this.events),this.hasBeenDragged=!0},startSession:function(){var e=s.currentPlaceholderIndex,t=this.model.get("order");if(this.model.get("isRecording")!==!0&&this.hasBeenDragged!==!0){this.undelegateEvents(),this.delegateEvents({mouseup:"stopSession"}),s.stopActiveSession(),s.logStartSession(this.model),this.model.startSession();var n=$(this.$el);this.animateSelectedTask(n,!0)}else this.hasBeenDragged===!0&&s.updateListOrder(t,e);s.currentPlaceholderIndex=Number.MAX_VALUE,this.hasBeenDragged=!1,this.mousedown=!1},stopSession:function(){if(this.model.get("isRecording")===!0){this.undelegateEvents(),this.delegateEvents(this.events),s.logStopSession(),this.model.stopSession();var e=$(this.$el);this.animateSelectedTask(e,!1)}},close:function(){},clear:function(){this.model.destroy()}}),u=Backbone.View.extend({el:$(".task-detail-view-container"),template:_.template("template"),events:{},initialize:function(){},render:function(){}}),a=new u,f=Backbone.View.extend({el:$("#tenKhoursapp"),initialize:function(){this.input=this.$("#new-task"),s.on("add",this.addOne,this),s.on("reset",this.addAll,this),s.fetch()},render:function(){},events:{"keypress #new-task":"createOnEnter"},addOne:function(e){var t=new o({model:e});this.$("#task-list").prepend(t.render().el)},addAll:function(){s.each(this.addOne)},createOnEnter:function(e){if(e.keyCode!==13)return;if(!this.input.val())return;s.create({title:this.input.val()}),this.input.val("")}}),l=new f;window.location="/#tasks";var c=Backbone.Router.extend({routes:{"task/:id":"getTask",tasks:"getAllTasks"}}),h=new c;h.on("route:getTask",function(e){$(l.el).fadeOut(200,function(){$(a.el).fadeIn(200)})}),h.on("route:getAllTasks",function(e){$(a.el).fadeOut(200,function(){$(l.el).fadeIn(200)})}),Backbone.history.start(),$("#task-list").sortable({start:function(e,t){$(t.placeholder).hide(100);var n=t.item.index();t.item.data("start_pos",n)},stop:function(e,t){},forcePlaceholderSize:!0,change:function(e,t){$(t.placeholder).hide().show(100);var n=t.item.data("start_pos"),r=t.placeholder.index();n<r&&(r-=1),s.currentPlaceholderIndex=r},placeholder:{element:function(e){return $("<li></li>")[0]},update:function(e,t){e.refreshPositions(),e.placeholder.css("backgroundColor","#eff6fc"),e.placeholder.css("borderColor","#4192d7"),e.placeholder.css("height","42px");return}}}),$("#task-list").disableSelection()});